#!/bin/sh

PACKAGE="$1"

if [ -z "$PACKAGE" ]; then
  echo "Usage: newpackage <packagename>"
  exit 1
fi

mkdir -p packages/$PACKAGE

cat > packages/$PACKAGE/meta <<EOF
PKG_NAME=$PACKAGE
PKG_VERSION=0.0invalid
PKG_URL="http://fill-in-$PACKAGE-$PKG_VERSION-download-url.invalid"
PKG_REV=1
PKG_DEPENDS="\$TARGET_LIBC"
PKG_BUILD_DEPENDS="toolchain"
PKG_PRIORITY=optional
PKG_SECTION=misc
PKG_SHORTDESC="$PACKAGE (autogenerated)"
PKG_LONGDESC=""
EOF

cat > packages/$PACKAGE/build <<EOF

#!/bin/sh

. config/options

get_meta vdr
VDR_VERSION=\$PKG_VERSION

get_meta linux
verlte 3.6.11 \$PKG_VERSION && INSDVB="yes" || INSDVB="no"
if [ \$INSDVB = "no" ]; then
   DVB_DIR="\$SYSROOT_PREFIX/usr/include"
else
   DVB_DIR="../linux"
fi

get_meta \$1
VDR_DIR=\`basename \$BUILD/vdr-\$VDR_VERSION\`

cd \$PKG_BUILD_DIR

make all \\
  VDRDIR="../\$VDR_DIR" \\
  DVBDIR=\$DVB_DIR \\
  LIBDIR="." \\
  LOCALEDIR="./locale" \\

#cp lib$1.so lib\$1.so.\${VDR_VERSION}
#do_strip bin lib\$1.so.*
get_meta vdr
verlte 1.7.36 \$PKG_VERSION && VDRINS="no" || VDRINS="yes"
if [ \$VDRINS = "yes" ]; then
  make_install
  rm -rf .install-debuginfo || true
else
  do_strip bin lib\$1.so.*
fi

EOF
chmod +x packages/$PACKAGE/build

cat > packages/$PACKAGE/install <<EOF
#!/bin/sh

. config/options

get_meta vdr
verlte 1.7.36 \$PKG_VERSION && VDRINS="no" || VDRINS="yes"

get_meta \$1
cd \$PKG_BUILD_DIR

NAME=\`echo \$1 | sed s/vdr-//\`
mkdir -p \$INSTALL/etc/vdr/plugins.d
echo "PLUGIN=\${NAME}" > \$INSTALL/etc/vdr/plugins.d/50_\$NAME
echo "ENABLED=yes" >> \$INSTALL/etc/vdr/plugins.d/50_\$NAME

if [ \$VDRINS = "no" ]; then
  mkdir -p \$INSTALL/usr/lib/vdr/plugins
  cp -a lib\$1*.so.* \$INSTALL/usr/lib/vdr/plugins
  for loc in \$INCLUDED_LOCALES; do
  LOCALE=\`echo \$loc|cut -f1 -d.\`
    if [ -d locale/\$LOCALE ]; then
      mkdir -p \$INSTALL/usr/share/locale/\$LOCALE
      cp -a locale/\$LOCALE/* \$INSTALL/usr/share/locale/\$LOCALE/
    fi
  done
else
  do_install usr
fi

EOF
chmod +x packages/$PACKAGE/install
