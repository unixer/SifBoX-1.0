#!/bin/sh

. config/options

get_meta $1

require_glibc $1

ZIP_PKG="`echo $PKG_URL | sed 's%.*/\(.*\)$%\1%'`"
[ -d $PKG_BUILD_DIR ] && rm -rf $PKG_BUILD_DIR

#sh $ATI_PKG --extract $PKG_BUILD_DIR
cd $PKG_BUILD_DIR

ATI_PKG="`basename $PKG_URL | sed 's/.zip//'`.run"
sh $ATI_PKG --extract .
cd -


if [ -d "$PACKAGES/$1/patches.ati/" ]; then
  for i in $PACKAGES/$1/patches.ati/*.diff*; do
    echo "## Applying patch: $i"
    cat $i | patch -d `echo $BUILD/$1* | cut -f1 -d\ ` -p1 >&$VERBOSE_OUT
  done
fi

for patch in `ls $PACKAGES/$1/patches.upstream/*.patch`; do
  cat $patch | patch -d \
    `echo $BUILD/$PKG_NAME-$PKG_VERSION | cut -f1 -d\ ` -p1
done
