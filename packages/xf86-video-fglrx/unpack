#!/bin/sh

. config/options

get_meta $1

require_glibc $1

ZIP_PKG="`echo $PKG_URL | sed 's%.*/\(.*\)$%\1%'`"
[ -d $PKG_BUILD_DIR ] && rm -rf $PKG_BUILD_DIR

mkdir -p $PKG_BUILD_DIR
  unzip $SOURCES/$1/$ZIP_PKG -d $BUILD/${PKG_NAME}-${PKG_VERSION} 2>&1
  ATI_PKG=`ls -d $PKG_BUILD_DIR/amd-driver-installer-*.run`
  sh $ATI_PKG --extract $PKG_BUILD_DIR

echo "### Applying upstream patches ###"

for patch in `ls $PACKAGES/$1/patches.upstream/*.patch`; do
  cat $patch | patch -d \
    `echo $BUILD/$PKG_NAME-$PKG_VERSION | cut -f1 -d\ ` -p1
done
